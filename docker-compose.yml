version: '3.8'

services:
  # Test Runner Service
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: test-runner
      cache_from:
        - api-test-agent:latest
    image: api-test-agent:latest
    container_name: api-test-runner

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # Environment configuration
    env_file:
      - .env
    environment:
      - NODE_ENV=test
      - CI=false
      - PLAYWRIGHT_WORKERS=2
      - PLAYWRIGHT_TIMEOUT=30000
      - TEST_OUTPUT_DIR=/app/tests/generated
      - TEST_REPORT_DIR=/app/test-results

    # Volume mounts for code and results
    volumes:
      # Mount source code (read-only for safety)
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro

      # Mount configuration files (read-only)
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./vitest.config.ts:/app/vitest.config.ts:ro
      - ./playwright.config.ts:/app/playwright.config.ts:ro
      - ./.env:/app/.env:ro

      # Mount result directories (read-write)
      - ./test-results:/app/test-results
      - ./coverage:/app/coverage
      - ./playwright-report:/app/playwright-report

      # Mount node_modules as volume for performance
      - node_modules:/app/node_modules

    # Network isolation
    networks:
      - test-network

    # Command override for interactive testing
    command: npm run test

    # Restart policy
    restart: on-failure

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Development service with watch mode
  test-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    image: api-test-agent:dev
    container_name: api-test-dev

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - CI=false

    volumes:
      # Mount everything for development
      - ./src:/app/src
      - ./tests:/app/tests
      - ./tsconfig.json:/app/tsconfig.json
      - ./vitest.config.ts:/app/vitest.config.ts
      - ./playwright.config.ts:/app/playwright.config.ts
      - ./.env:/app/.env
      - ./test-results:/app/test-results
      - ./coverage:/app/coverage
      - node_modules:/app/node_modules

    networks:
      - test-network

    command: npm run test:watch

    stdin_open: true
    tty: true

# Named volumes for node_modules
volumes:
  node_modules:
    driver: local

# Network configuration
networks:
  test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
